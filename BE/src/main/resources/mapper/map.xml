<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.popcon.map.mapper.MapMapper">

    <resultMap id="mapDto" type="MapDto">
        <result column="popup_id" property="popupId"/>
        <result column="popup_name" property="popupName"/>
        <result column="popup_latitude" property="popupLatitude"/>
        <result column="popup_longitude" property="popupLongitude"/>
        <result column="popup_staart" property="popupStart"/>
        <result column="popup_end" property="popupEnd"/>
        <result column="popup_like" property="popupLike"/>
        <result column="popup_location" property="popupLocation"/>
    </resultMap>

    <select id="findNearbyPopups" parameterType="Double" resultMap="mapDto">
        SELECT popup.popup_longitude, popup.popup_latitude, popup.popup_id,
          popup.popup_like, popup.popup_name, popup.popup_start, popup.popup_end,
          popup.popup_location,
               (
                   6371 * acos (
                           cos ( radians( popup.popup_latitude ) )
                               * cos( radians( #{latitude} ) )
                               * cos( radians( popup.popup_longitude ) - radians( #{longitude} ) )
                               + sin ( radians( popup.popup_latitude ) )
                               * sin( radians( #{latitude} ) )
                          )
                   ) distance,
            (select popup_image_path from popup_image
             where popup_image.popup_id=popup.popup_id order by popup_image_id limit 1) as previewImagePath
        FROM popup
        having distance <![CDATA[<=]]> 2
    </select>

    <select id="findCategories" parameterType="int" resultType="String">
        select category_name from popup_category
        where popup_id=#{popupId}
    </select>

<!--    <select id="findNearbyPopups" parameterType="Double" resultMap="mapDto">-->
<!--        SELECT-->
<!--            (-->
<!--                6371 * acos (-->
<!--                        cos ( radians( popup.popup_latitude ) )-->
<!--                            * cos( radians( #{latitude} ) )-->
<!--                            * cos( radians( popup.popup_longitude ) - radians( #{longitude} ) )-->
<!--                            + sin ( radians( popup.popup_latitude ) )-->
<!--                            * sin( radians( #{latitude} ) )-->
<!--                       )-->
<!--                ) AS distance , popup.popup_longitude, popup.popup_latitude, popup.popup_id,-->
<!--            popup.popup_name, popup.popup_location,popup.popup_start, popup.popup_end, popup.popup_like,-->
<!--            (select popup_image_path from popup_image-->
<!--             where popup_image.popup_id=popup.popup_id order by popup_image_id limit 1) as previewImagePath-->
<!--        FROM popup-->
<!--        HAVING distance <![CDATA[<=]]> 2-->
<!--    </select>-->

</mapper>